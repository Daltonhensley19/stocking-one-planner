<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - Stocking One Planner</title>
  <link rel="stylesheet" href="/public/css/styles.css">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="w-full max-w-md px-6">
    <div class="bg-white rounded-lg shadow-lg p-8">
      <h1 class="text-3xl font-bold text-gray-900 text-center mb-2">Stocking One Planner</h1>
      <p class="text-gray-600 text-center mb-8">Sign in to continue</p>

      <!-- Error message -->
      <div id="error-message" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-md">
        <p class="text-red-700 text-sm"></p>
      </div>

      <!-- Login form -->
      <form id="login-form" class="space-y-6">
        <div>
          <label for="username" class="block text-sm font-medium text-gray-700 mb-2">
            Username
          </label>
          <input
            type="text"
            id="username"
            name="username"
            required
            autocomplete="username"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Enter your username"
          />
        </div>

        <div>
          <label for="password" class="block text-sm font-medium text-gray-700 mb-2">
            Password
          </label>
          <input
            type="password"
            id="password"
            name="password"
            required
            autocomplete="current-password"
            class="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
            placeholder="Enter your password"
          />
        </div>

        <div class="flex items-center">
          <input
            type="checkbox"
            id="remember-me"
            name="rememberMe"
            class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500"
          />
          <label for="remember-me" class="ml-2 text-sm text-gray-700">
            Remember me for 7 days
          </label>
        </div>

        <button
          type="submit"
          id="login-button"
          class="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        >
          Sign In
        </button>
      </form>
    </div>

    <p class="text-center text-gray-600 text-sm mt-6">
      Secure access to your work planning dashboard
    </p>
  </div>

  <script>
    const loginForm = document.getElementById('login-form');
    const errorMessage = document.getElementById('error-message');
    const loginButton = document.getElementById('login-button');

    function showError(message) {
      errorMessage.querySelector('p').textContent = message;
      errorMessage.classList.remove('hidden');
    }

    function hideError() {
      errorMessage.classList.add('hidden');
    }

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();

      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const rememberMe = document.getElementById('remember-me').checked;

      // Disable button during login
      loginButton.disabled = true;
      loginButton.textContent = 'Signing in...';

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, rememberMe })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.message || 'Login failed');
        }

        // Store JWT token
        const storage = rememberMe ? localStorage : sessionStorage;
        storage.setItem('access_token', data.access_token);

        // Redirect to main page
        window.location.href = '/app';
      } catch (error) {
        showError(error.message);
        loginButton.disabled = false;
        loginButton.textContent = 'Sign In';
      }
    });

    // Check if already logged in with valid token
    const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');
    if (token) {
      // Verify token is still valid before redirecting
      fetch('/api/associates', {
        headers: { 'Authorization': `Bearer ${token}` }
      }).then(response => {
        if (response.ok) {
          // Token is valid, redirect to app
          window.location.href = '/app';
        } else {
          // Token is invalid, clear it
          localStorage.removeItem('access_token');
          sessionStorage.removeItem('access_token');
        }
      }).catch(() => {
        // Network error or invalid token, clear it
        localStorage.removeItem('access_token');
        sessionStorage.removeItem('access_token');
      });
    }
  </script>
</body>
</html>
