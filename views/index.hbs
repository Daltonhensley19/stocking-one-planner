<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stocking One Planner</title>
  <link rel="stylesheet" href="/public/css/styles.css">
</head>
<body class="bg-slate-100 h-screen flex flex-col">
  <!-- Corporate Header -->
  <div class="bg-slate-800 shadow-lg px-8 py-4 flex justify-between items-center border-b-4 border-blue-600">
    <div class="flex items-center space-x-4">
      <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
        </svg>
      </div>
      <div>
        <h1 class="text-xl font-bold text-white tracking-wide">STOCKING ONE PLANNER</h1>
        <p class="text-xs text-slate-300">Workforce Management System</p>
      </div>
    </div>
    <button
      id="logout-button"
      class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-6 rounded border border-slate-600 transition duration-200"
    >
      Sign Out
    </button>
  </div>

  <div class="flex flex-1 overflow-hidden">
    <!-- Left Sidebar -->
    <div class="w-96 bg-white border-r border-slate-200 flex flex-col overflow-y-auto">
      <div class="bg-slate-50 px-6 py-4 border-b border-slate-200">
        <h2 class="text-lg font-bold text-slate-800 uppercase tracking-wide">Team Management</h2>
      </div>

      <div class="p-6 space-y-6">
        <!-- Associates Dropdown -->
        <div>
          <label for="associates-select" class="block text-xs font-semibold text-slate-600 uppercase tracking-wide mb-2">
            Select Associate
          </label>
          <select
            id="associates-select"
            class="w-full px-4 py-2.5 border border-slate-300 rounded bg-white text-slate-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="">-- Select an Associate --</option>
          </select>
        </div>

        <!-- Add/Remove Associate Section -->
        <div class="border-t border-slate-200 pt-6">
          <h3 class="text-xs font-semibold text-slate-600 uppercase tracking-wide mb-4">Associate Controls</h3>

          <div class="space-y-3">
            <!-- Input for new associate -->
            <div>
              <label for="associate-input" class="block text-xs font-medium text-slate-600 mb-2">
                Full Name
              </label>
              <input
                type="text"
                id="associate-input"
                placeholder="Enter associate name..."
                class="w-full px-4 py-2.5 border border-slate-300 rounded bg-white text-slate-700 placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              />
            </div>

            <!-- Add/Remove Buttons -->
            <div class="flex gap-3">
              <button
                id="add-associate-btn"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded shadow-sm transition duration-200"
              >
                + Add
              </button>
              <button
                id="remove-associate-btn"
                class="flex-1 bg-slate-600 hover:bg-slate-700 text-white font-semibold py-2.5 px-4 rounded shadow-sm transition duration-200"
              >
                âˆ’ Remove
              </button>
            </div>
          </div>
        </div>

        <!-- Task Assignment Section (hidden until associate is selected) -->
        <div id="task-assignment-section" class="hidden border-t border-slate-200 pt-6">
          <h3 class="text-xs font-semibold text-slate-600 uppercase tracking-wide mb-3">
            Assign Tasks to: <span id="selected-associate-name" class="text-blue-600 font-bold"></span>
          </h3>

          <!-- Task List -->
          <div class="mt-4">
            <div id="task-list" class="space-y-2 max-h-80 overflow-y-auto">
              <!-- Tasks will be dynamically added here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 bg-slate-50 p-8 overflow-y-auto">
      <div class="max-w-7xl mx-auto">
        <div class="mb-6 flex justify-between items-center">
          <div>
            <h1 class="text-2xl font-bold text-slate-800 uppercase tracking-wide">Daily Work Plan</h1>
            <p class="text-sm text-slate-600 mt-1">Task assignments and workforce allocation</p>
          </div>
          <button
            id="view-text-btn"
            class="bg-slate-700 hover:bg-slate-600 text-white font-semibold py-2.5 px-6 rounded shadow-sm transition duration-200"
          >
            View as Text
          </button>
        </div>

        <!-- Text View Section (hidden by default) -->
        <div id="text-view-section" class="hidden mb-6 bg-white rounded-lg shadow border border-slate-200 p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 class="text-lg font-semibold text-slate-800 uppercase tracking-wide">Text Format</h2>
            <button
              id="close-text-btn"
              class="text-slate-500 hover:text-slate-700 font-semibold text-sm"
            >
              âœ• Close
            </button>
          </div>
          <textarea
            id="text-output"
            readonly
            class="w-full h-64 p-4 border-2 border-slate-300 rounded bg-slate-50 text-slate-800 font-mono text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 resize-y"
          ></textarea>
          <button
            id="copy-text-btn"
            class="mt-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded shadow-sm transition duration-200"
          >
            ðŸ“‹ Copy to Clipboard
          </button>
        </div>

        <!-- Assignments Overview -->
        <div class="bg-white rounded-lg shadow border border-slate-200">
          <div class="bg-slate-800 text-white px-6 py-4 rounded-t-lg">
            <h2 class="text-lg font-semibold uppercase tracking-wide">Current Assignments</h2>
          </div>
          <div id="assignments-overview" class="p-6">
            <p class="text-slate-500 italic">No associates added yet. Add an associate to get started.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
  </div>

  <script>
    // JWT Authentication handling
    const token = localStorage.getItem('access_token') || sessionStorage.getItem('access_token');

    // Redirect to login if no token
    if (!token) {
      window.location.href = '/';
    }

    // Helper function to make authenticated API requests
    async function authenticatedFetch(url, options = {}) {
      const headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`,
      };

      const response = await fetch(url, { ...options, headers });

      // If unauthorized, redirect to login
      if (response.status === 401) {
        localStorage.removeItem('access_token');
        sessionStorage.removeItem('access_token');
        window.location.href = '/';
        throw new Error('Unauthorized');
      }

      return response;
    }

    // Logout functionality
    document.getElementById('logout-button').addEventListener('click', () => {
      localStorage.removeItem('access_token');
      sessionStorage.removeItem('access_token');
      window.location.href = '/';
    });

    // Task list from tasks.txt
    const availableTasks = [
      "Paper, Pets, and Chemicals.",
      "New mod.",
      "Rollies.",
      "Automotive and Sporting goods.",
      "Housewares.",
      "Infants.",
      "Grocery and 95.",
      "Topsteel.",
      "Trailers.",
      "Scan early.",
      "Top Stock.",
      "Bikes, Crafts, Batteries, and Furniture."
    ];

    // Associates management
    let associates = []; // Array of { id, name } objects from database
    let assignedTasks = {}; // { associateName: [taskIndexes] }

    const associatesSelect = document.getElementById('associates-select');
    const associateInput = document.getElementById('associate-input');
    const addBtn = document.getElementById('add-associate-btn');
    const removeBtn = document.getElementById('remove-associate-btn');
    const taskAssignmentSection = document.getElementById('task-assignment-section');
    const selectedAssociateName = document.getElementById('selected-associate-name');
    const taskListContainer = document.getElementById('task-list');
    const assignmentsOverview = document.getElementById('assignments-overview');

    // Load associates from database
    async function loadAssociates() {
      try {
        const response = await authenticatedFetch('/api/associates');
        const data = await response.json();
        associates = data;
        associates.forEach(associate => {
          assignedTasks[associate.name] = [];
        });
        updateDropdown();
        updateAssignmentsOverview();
      } catch (error) {
        console.error('Failed to load associates:', error);
        if (error.message !== 'Unauthorized') {
          alert('Failed to load associates from database');
        }
      }
    }

    // Handle task checkbox changes
    function handleTaskCheckboxChange(checkbox) {
      const selectedIndex = associatesSelect.value;
      if (selectedIndex === '') return;

      const associate = associates[selectedIndex];
      const taskIndex = parseInt(checkbox.value);

      if (checkbox.checked) {
        // Add task if not already in the list
        if (!assignedTasks[associate.name].includes(taskIndex)) {
          assignedTasks[associate.name].push(taskIndex);
        }
      } else {
        // Remove task from the list
        assignedTasks[associate.name] = assignedTasks[associate.name].filter(
          t => t !== taskIndex
        );
      }

      // Update the table immediately
      updateAssignmentsOverview();
    }

    // Initialize task list
    function initializeTaskList() {
      taskListContainer.innerHTML = '';
      availableTasks.forEach((task, index) => {
        const taskDiv = document.createElement('div');
        taskDiv.className = 'flex items-center p-3.5 bg-slate-50 border border-slate-200 rounded hover:bg-blue-50 hover:border-blue-300 transition cursor-pointer active:bg-blue-100';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = `task-${index}`;
        checkbox.value = index;
        checkbox.className = 'task-checkbox w-5 h-5 text-blue-600 border-slate-300 rounded focus:ring-blue-500 focus:ring-2 flex-shrink-0 cursor-pointer';

        const label = document.createElement('label');
        label.htmlFor = `task-${index}`;
        label.className = 'ml-3 text-sm text-slate-700 cursor-pointer flex-1 select-none font-medium';
        label.textContent = `${index + 1}. ${task}`;

        // Make the entire row clickable
        taskDiv.addEventListener('click', function(e) {
          // Only toggle if we didn't click directly on the checkbox
          if (e.target !== checkbox) {
            checkbox.checked = !checkbox.checked;
            handleTaskCheckboxChange(checkbox);
          }
        });

        // Add change event listener for real-time updates
        checkbox.addEventListener('change', function() {
          handleTaskCheckboxChange(this);
        });

        taskDiv.appendChild(checkbox);
        taskDiv.appendChild(label);
        taskListContainer.appendChild(taskDiv);
      });
    }

    // Update task checkboxes based on current associate's assignments
    function updateTaskCheckboxes() {
      const selectedIndex = associatesSelect.value;
      if (selectedIndex === '') return;

      const associate = associates[selectedIndex];
      const currentTasks = assignedTasks[associate.name] || [];

      document.querySelectorAll('.task-checkbox').forEach((checkbox) => {
        checkbox.checked = currentTasks.includes(parseInt(checkbox.value));
      });
    }

    // Update assignments overview display
    function updateAssignmentsOverview() {
      if (associates.length === 0) {
        assignmentsOverview.innerHTML = '<p class="text-slate-500 italic">No associates added yet. Add an associate to get started.</p>';
        return;
      }

      let tableHTML = `
        <table class="min-w-full">
          <thead>
            <tr class="border-b-2 border-slate-300">
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider bg-slate-100 border-r border-slate-200">
                Associate Name
              </th>
              <th class="px-6 py-4 text-left text-xs font-bold text-slate-700 uppercase tracking-wider bg-slate-100">
                Assigned Tasks
              </th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-200">
      `;

      associates.forEach(associate => {
        const tasks = assignedTasks[associate.name] || [];
        const tasksList = tasks.length > 0
          ? `<ul class="list-disc list-inside text-slate-700 space-y-1.5">
              ${tasks.map(taskIndex => `<li class="text-sm">${availableTasks[taskIndex]}</li>`).join('')}
            </ul>`
          : '<span class="text-slate-400 italic text-sm">No tasks assigned</span>';

        tableHTML += `
          <tr class="hover:bg-slate-50 transition">
            <td class="px-6 py-4 text-sm font-semibold text-slate-800 border-r border-slate-200 bg-slate-50">
              ${associate.name}
            </td>
            <td class="px-6 py-4 text-sm text-slate-700">
              ${tasksList}
            </td>
          </tr>
        `;
      });

      tableHTML += `
          </tbody>
        </table>
      `;

      assignmentsOverview.innerHTML = tableHTML;
    }

    // Update dropdown with current associates
    function updateDropdown() {
      associatesSelect.innerHTML = '<option value="">-- Select an Associate --</option>';
      associates.forEach((associate, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.textContent = associate.name;
        associatesSelect.appendChild(option);
      });
    }

    // Add associate
    addBtn.addEventListener('click', async () => {
      const name = associateInput.value.trim();
      if (!name) {
        alert('Please enter a name!');
        return;
      }

      // Check if associate already exists
      if (associates.some(a => a.name === name)) {
        alert('Associate already exists!');
        return;
      }

      try {
        const response = await authenticatedFetch('/api/associates', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });

        if (!response.ok) {
          const error = await response.json();
          alert(error.message || 'Failed to add associate');
          return;
        }

        const newAssociate = await response.json();
        associates.push(newAssociate);
        assignedTasks[newAssociate.name] = [];
        updateDropdown();
        associateInput.value = '';
        updateAssignmentsOverview();

        // Auto-select the newly added associate
        const newIndex = associates.length - 1;
        associatesSelect.value = newIndex;

        // Trigger the change event to show task assignment section
        selectedAssociateName.textContent = newAssociate.name;
        taskAssignmentSection.classList.remove('hidden');
        updateTaskCheckboxes();
      } catch (error) {
        console.error('Failed to add associate:', error);
        alert('Failed to add associate to database');
      }
    });

    // Remove associate
    removeBtn.addEventListener('click', async () => {
      const selectedIndex = associatesSelect.value;
      if (selectedIndex === '') {
        alert('Please select an associate to remove!');
        return;
      }

      const associate = associates[selectedIndex];

      try {
        const response = await authenticatedFetch(`/api/associates/${associate.id}`, {
          method: 'DELETE'
        });

        if (!response.ok) {
          alert('Failed to remove associate');
          return;
        }

        // Remove from local array
        associates.splice(selectedIndex, 1);
        delete assignedTasks[associate.name];
        updateDropdown();
        taskAssignmentSection.classList.add('hidden');
        updateAssignmentsOverview();
        alert(`Removed: ${associate.name}`);
      } catch (error) {
        console.error('Failed to remove associate:', error);
        alert('Failed to remove associate from database');
      }
    });

    // When associate is selected, show task assignment section
    associatesSelect.addEventListener('change', () => {
      const selectedIndex = associatesSelect.value;
      if (selectedIndex !== '') {
        const associate = associates[selectedIndex];
        selectedAssociateName.textContent = associate.name;
        taskAssignmentSection.classList.remove('hidden');
        updateTaskCheckboxes();
      } else {
        taskAssignmentSection.classList.add('hidden');
      }
    });

    // Allow Enter key to add associate
    associateInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addBtn.click();
      }
    });

    // Initialize task list and load associates from database on page load
    initializeTaskList();
    loadAssociates();

    // Text view functionality
    const viewTextBtn = document.getElementById('view-text-btn');
    const closeTextBtn = document.getElementById('close-text-btn');
    const copyTextBtn = document.getElementById('copy-text-btn');
    const textViewSection = document.getElementById('text-view-section');
    const textOutput = document.getElementById('text-output');

    function generateTextFormat() {
      if (associates.length === 0) {
        return 'No associates added yet.';
      }

      let text = '';
      associates.forEach(associate => {
        const tasks = assignedTasks[associate.name] || [];
        text += `${associate.name}:\n`;

        if (tasks.length > 0) {
          tasks.forEach(taskIndex => {
            text += `  - ${availableTasks[taskIndex]}\n`;
          });
        } else {
          text += `  (No tasks assigned)\n`;
        }
        text += '\n';
      });

      return text.trim();
    }

    viewTextBtn.addEventListener('click', () => {
      textOutput.value = generateTextFormat();
      textViewSection.classList.remove('hidden');
    });

    closeTextBtn.addEventListener('click', () => {
      textViewSection.classList.add('hidden');
    });

    copyTextBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(textOutput.value);
        const originalText = copyTextBtn.textContent;
        copyTextBtn.textContent = 'âœ“ Copied!';
        copyTextBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        copyTextBtn.classList.add('bg-green-600', 'hover:bg-green-700');

        setTimeout(() => {
          copyTextBtn.textContent = originalText;
          copyTextBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
          copyTextBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }, 2000);
      } catch (err) {
        alert('Failed to copy to clipboard');
      }
    });
  </script>
</body>
</html>
